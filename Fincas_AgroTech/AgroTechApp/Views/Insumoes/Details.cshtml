@model AgroTechApp.Models.DB.Insumo

@{
    ViewData["Title"] = "Detalles del Insumo";

    // Datos del ViewBag que deben venir del controller
    var stockActual = (decimal)(ViewBag.StockActual ?? 0m);
    var movimientos = (int)(ViewBag.TotalMovimientos ?? 0);
    var ultimoMovimiento = ViewBag.UltimoMovimiento as DateTime?;
    var actividadReciente = ViewBag.ActividadReciente as List<dynamic> ?? new List<dynamic>();

    // Calcular porcentaje de stock
    var porcentajeStock = Model.StockMinimo > 0
        ? Math.Min((stockActual / Model.StockMinimo) * 100, 100)
        : 0;

    // Determinar estado del stock
    string estadoStock = "out";
    string estadoTexto = "Agotado";
    string estadoClase = "status-out";
    string progressClase = "progress-low";

    if (stockActual > 0)
    {
        if (stockActual > Model.StockMinimo)
        {
            estadoStock = "available";
            estadoTexto = "Disponible";
            estadoClase = "status-available";
            progressClase = "progress-high";
        }
        else
        {
            estadoStock = "low";
            estadoTexto = "Stock Bajo";
            estadoClase = "status-low";
            progressClase = "progress-medium";
        }
    }
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - AgroTech</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2E8B57;
            --primary-dark: #26734d;
            --primary-light: #3CB371;
            --secondary: #F4A460;
            --accent: #FF6B35;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --border: #e1e5e9;
            --shadow: rgba(0, 0, 0, 0.1);
            --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
            color: var(--dark);
            min-height: 100vh;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: var(--gray);
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow);
        }

            .breadcrumb a {
                color: var(--primary);
                text-decoration: none;
                transition: color 0.3s;
            }

                .breadcrumb a:hover {
                    color: var(--primary-dark);
                }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 2rem;
        }

        @@media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1.5rem 2rem;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

            .card-title i {
                color: var(--primary);
            }

        .card-body {
            padding: 2rem;
        }

        /* Insumo Header */
        .insumo-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
        }

        .insumo-icon {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            flex-shrink: 0;
            box-shadow: 0 8px 20px rgba(46, 139, 87, 0.3);
        }

        .insumo-basic-info h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .insumo-code {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 0.75rem;
        }

        .insumo-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1.25rem;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-available {
            background: #d4edda;
            color: var(--success);
        }

        .status-low {
            background: #fff3cd;
            color: #856404;
        }

        .status-out {
            background: #f8d7da;
            color: var(--danger);
        }

        /* Alert */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

            .alert i {
                font-size: 1.3rem;
                margin-top: 0.15rem;
            }

        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid var(--warning);
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid var(--info);
            color: #0c5460;
        }

        /* Details Grid */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .detail-group {
            margin-bottom: 1.5rem;
        }

        .detail-label {
            font-weight: 600;
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

            .detail-label i {
                color: var(--primary);
            }

        .detail-value {
            color: var(--dark);
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Stock Info */
        .stock-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            border-left: 5px solid var(--primary);
        }

        .stock-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .stock-label {
            text-align: center;
            color: var(--gray);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        /* Progress Bar */
        .progress-container {
            margin: 1.5rem 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--dark);
        }

        .progress-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease;
        }

        .progress-low {
            background: linear-gradient(90deg, var(--danger), #ff6b6b);
        }

        .progress-medium {
            background: linear-gradient(90deg, var(--warning), #ffda44);
        }

        .progress-high {
            background: linear-gradient(90deg, var(--success), #51cf66);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.85rem 1.75rem;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.65rem;
            text-decoration: none;
            justify-content: center;
        }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

            .btn-outline:hover {
                background: var(--primary);
                color: white;
            }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e74c3c);
            color: white;
        }

        /* Sidebar */
        .sidebar-card {
            background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

            .sidebar-title i {
                color: var(--primary);
            }

        /* History List */
        .history-list {
            list-style: none;
        }

        .history-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }

            .history-item:last-child {
                border-bottom: none;
            }

        .history-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            flex-shrink: 0;
            font-size: 1.1rem;
        }

        .history-content {
            flex: 1;
        }

        .history-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .history-date {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 0.25rem;
        }

        .history-detail {
            font-size: 0.9rem;
            color: var(--dark);
            font-weight: 500;
        }

        /* Animations */
        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease forwards;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .insumo-header {
                flex-direction: column;
                text-align: center;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .details-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb fade-in">
            <a asp-action="Index" asp-controller="Home"><i class="fas fa-home"></i> Inicio</a>
            <i class="fas fa-chevron-right"></i>
            <a asp-action="Index"><i class="fas fa-boxes"></i> Insumos</a>
            <i class="fas fa-chevron-right"></i>
            <span>@Model.Nombre</span>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Insumo Details Card -->
                <div class="card fade-in">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-info-circle"></i>
                            Información del Insumo
                        </h2>
                    </div>
                    <div class="card-body">
                        <!-- Insumo Header -->
                        <div class="insumo-header">
                            <div class="insumo-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="insumo-basic-info">
                                <h2>@Model.Nombre</h2>
                                <div class="insumo-code">
                                    <i class="fas fa-hashtag"></i> ID: @Model.InsumoId
                                </div>
                                <div class="insumo-status @estadoClase">
                                    <i class="fas fa-circle"></i>
                                    @estadoTexto
                                </div>
                            </div>
                        </div>

                        <!-- Alert -->
                        @if (stockActual == 0)
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>Stock agotado:</strong> Este insumo no tiene existencias disponibles.
                                    Es necesario realizar un pedido urgente.
                                </div>
                            </div>
                        }
                        else if (stockActual <= Model.StockMinimo)
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>Stock bajo:</strong> Este insumo está por debajo del nivel mínimo recomendado (@Model.StockMinimo @Model.Unidad.Nombre).
                                    Considere realizar un nuevo pedido.
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <div>
                                    <strong>Stock óptimo:</strong> El nivel de existencias es adecuado.
                                </div>
                            </div>
                        }

                        <!-- Details Grid -->
                        <div class="details-grid">
                            <div>
                                <div class="detail-group">
                                    <div class="detail-label">
                                        <i class="fas fa-tag"></i>
                                        Categoría
                                    </div>
                                    <div class="detail-value">@Model.Categoria.Nombre</div>
                                </div>
                                <div class="detail-group">
                                    <div class="detail-label">
                                        <i class="fas fa-building"></i>
                                        Finca
                                    </div>
                                    <div class="detail-value">@Model.Finca.Nombre</div>
                                </div>
                                <div class="detail-group">
                                    <div class="detail-label">
                                        <i class="fas fa-weight"></i>
                                        Unidad de Medida
                                    </div>
                                    <div class="detail-value">@Model.Unidad.Nombre</div>
                                </div>
                            </div>
                            <div>
                                <div class="detail-group">
                                    <div class="detail-label">
                                        <i class="fas fa-boxes"></i>
                                        Stock Mínimo
                                    </div>
                                    <div class="detail-value">@Model.StockMinimo.ToString("N2") @Model.Unidad.Nombre</div>
                                </div>
                                <div class="detail-group">
                                    <div class="detail-label">
                                        <i class="fas fa-chart-line"></i>
                                        Total Movimientos
                                    </div>
                                    <div class="detail-value">@movimientos</div>
                                </div>
                                <div class="detail-group">
                                    <div class="detail-label">
                                        <i class="fas fa-power-off"></i>
                                        Estado
                                    </div>
                                    <div class="detail-value">
                                        @if (Model.Activo)
                                        {
                                            <span style="color: var(--success);">
                                                <i class="fas fa-check-circle"></i> Activo
                                            </span>
                                        }
                                        else
                                        {
                                            <span style="color: var(--danger);">
                                                <i class="fas fa-times-circle"></i> Inactivo
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Information -->
                        <div class="stock-info">
                            <div class="stock-value">@stockActual.ToString("N2") @Model.Unidad.Nombre</div>
                            <div class="stock-label">Stock Actual Disponible</div>

                            <div class="progress-container">
                                <div class="progress-label">
                                    <span>Nivel de Stock vs. Mínimo</span>
                                    <span>@porcentajeStock.ToString("F0")%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill @progressClase" style="width: @porcentajeStock%"></div>
                                </div>
                            </div>

                            @if (ultimoMovimiento.HasValue)
                            {
                                <div class="detail-group" style="text-align: center; margin-top: 1rem;">
                                    <div class="detail-label" style="justify-content: center;">
                                        <i class="fas fa-clock"></i>
                                        Último Movimiento
                                    </div>
                                    <div class="detail-value">@ultimoMovimiento.Value.ToString("dd/MM/yyyy HH:mm")</div>
                                </div>
                            }
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <a asp-action="Edit" asp-route-id="@Model.InsumoId" class="btn btn-primary">
                                <i class="fas fa-edit"></i>
                                Editar Insumo
                            </a>
                            <a asp-controller="Inventario" asp-action="Entrada" asp-route-insumoId="@Model.InsumoId" class="btn btn-outline">
                                <i class="fas fa-arrow-down"></i>
                                Registrar Entrada
                            </a>
                            <a asp-controller="Inventario" asp-action="Consumo" asp-route-insumoId="@Model.InsumoId" class="btn btn-outline">
                                <i class="fas fa-arrow-up"></i>
                                Registrar Consumo
                            </a>
                            <a asp-controller="Inventario" asp-action="Historial" asp-route-insumoId="@Model.InsumoId" class="btn btn-outline">
                                <i class="fas fa-history"></i>
                                Ver Historial
                            </a>
                            <a asp-action="Delete" asp-route-id="@Model.InsumoId" class="btn btn-danger">
                                <i class="fas fa-trash"></i>
                                Eliminar
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Sidebar -->
            <div class="right-column">
                <!-- Quick Actions -->
                <div class="sidebar-card fade-in">
                    <h3 class="sidebar-title">
                        <i class="fas fa-bolt"></i>
                        Acciones Rápidas
                    </h3>
                    <div class="action-buttons" style="flex-direction: column;">
                        <a asp-action="Index" class="btn btn-outline" style="width: 100%;">
                            <i class="fas fa-list"></i>
                            Volver al Listado
                        </a>
                        <a asp-action="Create" class="btn btn-outline" style="width: 100%;">
                            <i class="fas fa-plus-circle"></i>
                            Nuevo Insumo
                        </a>
                        <a asp-controller="Inventario" asp-action="Dashboard" class="btn btn-outline" style="width: 100%;">
                            <i class="fas fa-chart-pie"></i>
                            Dashboard Inventario
                        </a>
                    </div>
                </div>

                <!-- Recent Activity -->
                @if (actividadReciente != null && actividadReciente.Count > 0)
                {
                    <div class="sidebar-card fade-in">
                        <h3 class="sidebar-title">
                            <i class="fas fa-history"></i>
                            Actividad Reciente
                        </h3>
                        <ul class="history-list">
                            @foreach (var item in actividadReciente.Take(5))
                            {
                                <li class="history-item">
                                    <div class="history-icon">
                                        @if (item.Tipo == "Entrada" || item.Tipo == "Compra")
                                        {
                                            <i class="fas fa-arrow-down" style="color: var(--success);"></i>
                                        }
                                        else
                                        {
                                            <i class="fas fa-arrow-up" style="color: var(--danger);"></i>
                                        }
                                    </div>
                                    <div class="history-content">
                                        <div class="history-title">@item.Tipo</div>
                                        <div class="history-date">@item.Fecha.ToString("dd/MM/yyyy HH:mm")</div>
                                        <div class="history-detail">
                                            @(item.Tipo == "Entrada" || item.Tipo == "Compra" ? "+" : "-")@item.Cantidad.ToString("N2") @Model.Unidad.Nombre
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                        <a asp-controller="Inventario" asp-action="Historial" asp-route-insumoId="@Model.InsumoId"
                           class="btn btn-outline" style="width: 100%; margin-top: 1rem;">
                            <i class="fas fa-list"></i>
                            Ver Historial Completo
                        </a>
                    </div>
                }
                else
                {
                    <div class="sidebar-card fade-in">
                        <h3 class="sidebar-title">
                            <i class="fas fa-history"></i>
                            Actividad Reciente
                        </h3>
                        <div style="text-align: center; padding: 2rem; color: var(--gray);">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p>No hay movimientos registrados</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Animate progress bar
            const progressFill = document.querySelector('.progress-fill');
            if (progressFill) {
                setTimeout(() => {
                    progressFill.style.width = '@porcentajeStock%';
                }, 300);
            }

            // Fade in animations
            const fadeElements = document.querySelectorAll('.fade-in');
            fadeElements.forEach((el, index) => {
                el.style.animationDelay = `${index * 0.1}s`;
            });
        });
    </script>
</body>
</html>
